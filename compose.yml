services:
  openssh-server:
    image: linuxserver/openssh-server:latest
    # TODO: remove CONTAINER_NAME and HOSTNAME from .env on actual host
    container_name: music-server
    hostname: music-server
    env_file: .env.server
    volumes:
      - ./server/config:/config
      # TODO: inherit from linuxserver/openssh-server Dockerfile
      # and add `apk install rsync` as a build step
      - ./server/custom-cont-init.d:/custom-cont-init.d
      - ./music:/music
    ports:
      - ${SSH_PORT}:2222
    restart: unless-stopped

  ssh-tunnel:
    build: tunnel
    container_name: music-server-tunnel
    env_file: .env.tunnel
    network_mode: "service:openssh-server"
    restart: unless-stopped
    healthcheck:
      test: "[ $(curl -s http://localhost:4040/api/tunnels | jq -r '.tunnels[0].config.addr') == 'localhost:2222' ]"
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 10s

  telegram-bot:
    build: telegram_bot
    container_name: music-server-bot
    env_file: .env.bot
    network_mode: "service:openssh-server"
    volumes:
      - ./music:/music
    depends_on:
      ssh-tunnel:
        condition: service_healthy
    restart: unless-stopped
